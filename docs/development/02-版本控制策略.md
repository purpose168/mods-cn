# 版本控制策略

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-13
- **最后更新**: 2026-02-13
- **维护人员**: purpose168@outlook.com

---

## 1. 概述

本文档定义了 Mods 项目的版本控制策略，包括分支管理策略、代码合并流程、版本号命名规则等内容，旨在确保代码库的稳定性和可维护性。

---

## 2. 分支管理策略

### 2.1 分支模型

采用简化的 Git Flow 模型：

```
                    ┌─────────────────────────────────────┐
                    │              main                    │
                    │         (生产分支)                    │
                    └─────────────────────────────────────┘
                              ↑
                              │ merge (PR)
                              │
                    ┌─────────────────────────────────────┐
                    │            develop                   │
                    │          (开发分支)                   │
                    └─────────────────────────────────────┘
                              ↑
          ┌───────────────────┼───────────────────┐
          │                   │                   │
    ┌─────┴─────┐       ┌─────┴─────┐       ┌─────┴─────┐
    │ feature/  │       │  bugfix/  │       │  hotfix/  │
    │   xxx     │       │    xxx    │       │    xxx    │
    └───────────┘       └───────────┘       └───────────┘
```

### 2.2 分支类型

| 分支类型 | 命名规范 | 说明 | 生命周期 |
|----------|----------|------|----------|
| **main** | `main` | 生产分支，始终稳定 | 永久 |
| **develop** | `develop` | 开发分支，集成最新功能 | 永久 |
| **feature** | `feature/<功能名>` | 新功能开发 | 临时 |
| **bugfix** | `bugfix/<问题描述>` | Bug 修复 | 临时 |
| **hotfix** | `hotfix/<问题描述>` | 紧急修复 | 临时 |
| **release** | `release/<版本号>` | 发布准备 | 临时 |

### 2.3 分支命名示例

```bash
# 功能分支
feature/add-deepseek-support
feature/mcp-server-integration
feature/custom-themes

# Bug 修复分支
bugfix/cache-race-condition
bugfix/config-parsing-error

# 紧急修复分支
hotfix/api-key-validation
hotfix/memory-leak

# 发布分支
release/v1.2.0
release/v2.0.0-beta.1
```

---

## 3. 工作流程

### 3.1 功能开发流程

```
1. 从 develop 创建功能分支
       │
       ▼
git checkout develop
git pull origin develop
git checkout -b feature/new-feature
       │
       ▼
2. 开发和提交
       │
       ▼
git add .
git commit -m "feat: 添加新功能"
       │
       ▼
3. 推送到远程
       │
       ▼
git push origin feature/new-feature
       │
       ▼
4. 创建 Pull Request
       │
       ▼
5. 代码审查
       │
       ▼
6. 合并到 develop
       │
       ▼
7. 删除功能分支
       │
       ▼
git branch -d feature/new-feature
git push origin --delete feature/new-feature
```

### 3.2 Bug 修复流程

```
1. 从 develop 创建修复分支
       │
       ▼
git checkout develop
git pull origin develop
git checkout -b bugfix/issue-description
       │
       ▼
2. 修复和测试
       │
       ▼
3. 提交修复
       │
       ▼
git commit -m "fix: 修复问题描述"
       │
       ▼
4. 创建 PR 并合并
```

### 3.3 紧急修复流程

```
1. 从 main 创建 hotfix 分支
       │
       ▼
git checkout main
git pull origin main
git checkout -b hotfix/critical-fix
       │
       ▼
2. 修复和测试
       │
       ▼
3. 合并到 main 和 develop
       │
       ▼
git checkout main
git merge hotfix/critical-fix
git tag -a v1.0.1 -m "Hotfix v1.0.1"
git push origin main --tags

git checkout develop
git merge hotfix/critical-fix
git push origin develop
       │
       ▼
4. 删除 hotfix 分支
```

### 3.4 发布流程

```
1. 从 develop 创建 release 分支
       │
       ▼
git checkout develop
git checkout -b release/v1.2.0
       │
       ▼
2. 版本准备
   - 更新版本号
   - 更新 CHANGELOG
   - 最终测试
       │
       ▼
3. 合并到 main
       │
       ▼
git checkout main
git merge release/v1.2.0
git tag -a v1.2.0 -m "Release v1.2.0"
git push origin main --tags
       │
       ▼
4. 合并回 develop
       │
       ▼
git checkout develop
git merge release/v1.2.0
git push origin develop
       │
       ▼
5. 删除 release 分支
```

---

## 4. 版本号命名规则

### 4.1 语义化版本

遵循 [Semantic Versioning 2.0.0](https://semver.org/) 规范：

```
MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]

示例:
- v1.0.0          正式版本
- v1.1.0          新功能版本
- v1.1.1          Bug 修复版本
- v2.0.0          重大更新版本
- v1.0.0-beta.1   预发布版本
- v1.0.0+build.1  包含构建元数据
```

### 4.2 版本号递增规则

| 变更类型 | 版本递增 | 示例 |
|----------|----------|------|
| 不兼容的 API 变更 | MAJOR | 1.0.0 → 2.0.0 |
| 向后兼容的新功能 | MINOR | 1.0.0 → 1.1.0 |
| 向后兼容的 Bug 修复 | PATCH | 1.0.0 → 1.0.1 |

### 4.3 预发布版本

```bash
# Alpha 版本 - 内部测试
v1.0.0-alpha.1
v1.0.0-alpha.2

# Beta 版本 - 公开测试
v1.0.0-beta.1
v1.0.0-beta.2

# Release Candidate - 发布候选
v1.0.0-rc.1
v1.0.0-rc.2
```

---

## 5. 提交规范

### 5.1 提交消息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 5.2 提交类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **feat** | 新功能 | feat(api): 添加 DeepSeek 支持 |
| **fix** | Bug 修复 | fix(cache): 修复并发写入问题 |
| **docs** | 文档更新 | docs: 更新安装说明 |
| **style** | 代码格式 | style: 格式化代码 |
| **refactor** | 重构 | refactor(config): 优化配置加载 |
| **test** | 测试相关 | test: 添加缓存单元测试 |
| **chore** | 构建/工具 | chore: 更新依赖版本 |
| **perf** | 性能优化 | perf: 优化流式响应处理 |

### 5.3 Scope 范围

| Scope | 说明 |
|-------|------|
| api | API 相关 |
| cache | 缓存模块 |
| config | 配置模块 |
| db | 数据库模块 |
| mcp | MCP 集成 |
| ui | 用户界面 |
| docs | 文档 |

### 5.4 提交示例

```bash
# 新功能
feat(api): 添加 Gemini 2.0 Flash 模型支持

- 支持 gemini-2.0-flash-001 模型
- 添加 thinking-budget 配置选项
- 更新配置模板文件

Closes #123

# Bug 修复
fix(cache): 修复对话缓存并发写入问题

使用互斥锁保护缓存写入操作，防止并发写入导致数据损坏。

Fixes #456

# 文档更新
docs: 更新 API 密钥配置说明

添加各 API 提供商的密钥获取链接和配置方法。
```

---

## 6. Pull Request 规范

### 6.1 PR 标题格式

```
<type>(<scope>): <description>

示例:
feat(api): 添加 Claude 3.5 Sonnet 支持
fix(db): 修复对话查询性能问题
docs: 更新部署文档
```

### 6.2 PR 模板

```markdown
## 变更类型
- [ ] 新功能 (feat)
- [ ] Bug 修复 (fix)
- [ ] 文档更新 (docs)
- [ ] 重构 (refactor)
- [ ] 其他

## 变更说明
<!-- 描述本次变更的内容 -->

## 相关 Issue
<!-- 关联的 Issue 编号 -->
Closes #

## 测试
- [ ] 已添加单元测试
- [ ] 已添加集成测试
- [ ] 已手动测试

## 检查清单
- [ ] 代码符合项目编码规范
- [ ] 已更新相关文档
- [ ] 已通过所有 CI 检查
- [ ] 已自我审查代码
```

### 6.3 PR 审查流程

```
1. 创建 PR
       │
       ▼
2. 自动检查
   ├── CI 测试
   ├── Lint 检查
   └── 构建验证
       │
       ▼
3. 代码审查
   ├── 至少 1 位审查者
   ├── 解决所有评论
   └── 获得批准
       │
       ▼
4. Squash 合并
       │
       ▼
5. 删除分支
```

---

## 7. 代码合并策略

### 7.1 合并方式

| 方式 | 适用场景 | 说明 |
|------|----------|------|
| **Squash and Merge** | 功能分支 | 将多个提交压缩为一个 |
| **Merge Commit** | Release 分支 | 保留完整历史 |
| **Rebase and Merge** | 简单修复 | 保持线性历史 |

### 7.2 冲突解决

```bash
# 拉取最新代码
git checkout develop
git pull origin develop

# 切换到功能分支并 rebase
git checkout feature/my-feature
git rebase develop

# 解决冲突
# 编辑冲突文件...

# 标记冲突已解决
git add .
git rebase --continue

# 强制推送
git push origin feature/my-feature --force-with-lease
```

---

## 8. 标签管理

### 8.1 标签类型

| 类型 | 格式 | 示例 |
|------|------|------|
| **Release** | `v<版本号>` | v1.0.0 |
| **Pre-release** | `v<版本号>-<类型>.<序号>` | v1.0.0-beta.1 |

### 8.2 创建标签

```bash
# 创建带注释的标签
git tag -a v1.0.0 -m "Release v1.0.0"

# 推送标签到远程
git push origin v1.0.0

# 推送所有标签
git push origin --tags

# 删除本地标签
git tag -d v1.0.0

# 删除远程标签
git push origin --delete v1.0.0
```

---

## 9. CHANGELOG 管理

### 9.1 CHANGELOG 格式

```markdown
# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased]

### Added
- 新功能描述

### Changed
- 变更描述

### Fixed
- 修复描述

## [1.0.0] - 2024-01-01

### Added
- 初始版本发布
```

### 9.2 变更类型

| 类型 | 说明 |
|------|------|
| **Added** | 新增功能 |
| **Changed** | 功能变更 |
| **Deprecated** | 即将废弃 |
| **Removed** | 已移除 |
| **Fixed** | Bug 修复 |
| **Security** | 安全相关 |

---

## 10. Git 钩子

### 10.1 Pre-commit 钩子

```bash
#!/bin/bash
# .git/hooks/pre-commit

# 运行代码格式化
gofmt -w .

# 运行 lint 检查
golangci-lint run

# 运行测试
go test ./...
```

### 10.2 Commit-msg 钩子

```bash
#!/bin/bash
# .git/hooks/commit-msg

# 验证提交消息格式
commit_msg=$(cat "$1")
pattern="^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .{1,50}"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo "提交消息格式错误"
    echo "格式: <type>(<scope>): <subject>"
    echo "示例: feat(api): 添加新功能"
    exit 1
fi
```

---

## 附录

### A. Git 命令速查

| 命令 | 说明 |
|------|------|
| `git branch <name>` | 创建分支 |
| `git checkout <branch>` | 切换分支 |
| `git checkout -b <branch>` | 创建并切换分支 |
| `git merge <branch>` | 合并分支 |
| `git rebase <branch>` | 变基 |
| `git cherry-pick <commit>` | 选择性合并 |
| `git stash` | 暂存更改 |
| `git stash pop` | 恢复暂存 |
| `git reset --soft HEAD~1` | 撤销最后一次提交 |
| `git revert <commit>` | 撤销指定提交 |

### B. 相关文档

- [开发规范](../development/01-开发规范.md)
- [构建部署流程](../deployment/01-构建部署流程.md)
- [测试策略](../testing/01-测试策略.md)

### C. 外部资源

- [Semantic Versioning](https://semver.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Git Flow](https://nvie.com/posts/a-successful-git-branching-model/)

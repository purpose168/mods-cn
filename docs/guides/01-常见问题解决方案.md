# 常见问题解决方案

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-13
- **最后更新**: 2026-02-13
- **维护人员**: purpose168@outlook.com

---

## 1. 概述

本文档整理了 Mods 项目在开发、测试、部署过程中常见问题的诊断方法和解决策略，帮助开发者快速定位和解决问题。

---

## 2. 安装与配置问题

### 2.1 安装失败

#### 问题: Go 版本不兼容

**症状**:
```
go: cannot find main module; ...
或
package requires Go 1.24.2 or later
```

**解决方案**:
```bash
# 检查当前 Go 版本
go version

# 更新 Go 到 1.24.2+
# macOS
brew upgrade go

# Ubuntu/Debian
sudo apt update
sudo apt install golang-go

# 或从官网下载安装
# https://go.dev/dl/
```

#### 问题: 依赖下载失败

**症状**:
```
go: github.com/xxx/yyy: reading at revision xxx: unknown revision
或
dial tcp: lookup proxy.golang.org: no such host
```

**解决方案**:
```bash
# 设置 Go 代理（中国大陆）
go env -w GOPROXY=https://goproxy.cn,direct
go env -w GOSUMDB=sum.golang.google.cn

# 清理缓存重新下载
go clean -modcache
go mod download

# 验证依赖
go mod verify
```

### 2.2 配置问题

#### 问题: 配置文件找不到

**症状**:
```
无法加载您的配置文件
```

**解决方案**:
```bash
# 查看配置文件位置
mods --dirs

# 手动创建配置目录
mkdir -p ~/.config/mods

# 重置配置
mods --reset-settings

# 或手动编辑配置
mods --settings
```

#### 问题: API 密钥未配置

**症状**:
```
需要 OPENAI_API_KEY；设置环境变量 OPENAI_API_KEY 或通过 mods --settings 更新 mods.yaml
```

**解决方案**:
```bash
# 方法 1: 设置环境变量
export OPENAI_API_KEY="sk-..."
echo 'export OPENAI_API_KEY="sk-..."' >> ~/.bashrc

# 方法 2: 配置文件
mods --settings
# 在配置文件中设置:
# apis:
#   openai:
#     api-key: "sk-..."

# 方法 3: 使用命令获取密钥
# 在配置文件中设置:
# apis:
#   openai:
#     api-key-cmd: "rbw get -f OPENAI_API_KEY chat.openai.com"
```

---

## 3. 运行时问题

### 3.1 API 调用问题

#### 问题: API 连接超时

**症状**:
```
context deadline exceeded
或
connection timed out
```

**解决方案**:
```bash
# 检查网络连接
ping api.openai.com

# 使用代理
export HTTP_PROXY="http://proxy:8080"
export HTTPS_PROXY="http://proxy:8080"

# 或在配置中设置
mods --http-proxy "http://proxy:8080" "你的提示"

# 增加超时时间（如果支持）
# 检查网络是否被防火墙阻止
```

#### 问题: API 密钥无效

**症状**:
```
Incorrect API key provided
或
Unauthorized
```

**解决方案**:
```bash
# 验证密钥格式
echo $OPENAI_API_KEY

# 检查密钥是否有效
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY"

# 重新生成密钥
# 访问 https://platform.openai.com/account/api-keys
```

#### 问题: 上下文长度超限

**症状**:
```
This model's maximum context length is 8192 tokens. However, your messages resulted in 10000 tokens
```

**解决方案**:
```bash
# 方法 1: 使用更大上下文的模型
mods -m gpt-4-32k "你的提示"

# 方法 2: 减少输入长度
mods --max-input-chars 10000 "你的提示"

# 方法 3: 使用 --no-limit 跳过客户端检查（可能仍会失败）
mods --no-limit "你的提示"

# 方法 4: 截断标准输入
cat file.txt | head -100 | mods "总结这段文本"
```

### 3.2 模型问题

#### 问题: 模型不存在

**症状**:
```
API 端点 openai 不包含模型 gpt-5
```

**解决方案**:
```bash
# 查看可用模型
mods --settings
# 检查配置文件中的 models 部分

# 使用正确的模型名称
mods -m gpt-4o "你的提示"

# 使用模型别名
mods -m 4o "你的提示"  # gpt-4o 的别名
```

#### 问题: 模型响应慢

**症状**:
响应生成时间过长

**解决方案**:
```bash
# 使用更快的模型
mods -m gpt-4o-mini "你的提示"

# 减少最大令牌数
mods --max-tokens 100 "你的提示"

# 使用本地模型 (Ollama)
mods -a ollama -m llama3.2 "你的提示"
```

### 3.3 缓存问题

#### 问题: 对话无法保存

**症状**:
```
对话未保存，因为设置了 --no-cache 或 NO_CACHE
```

**解决方案**:
```bash
# 移除 --no-cache 标志
mods "你的提示"  # 不使用 --no-cache

# 检查环境变量
unset MODS_NO_CACHE
unset NO_CACHE

# 检查缓存目录权限
ls -la ~/.local/share/mods/
chmod 755 ~/.local/share/mods/
```

#### 问题: 对话加载失败

**症状**:
```
加载对话时出错
```

**解决方案**:
```bash
# 检查缓存文件
ls -la ~/.local/share/mods/conversations/

# 检查数据库
ls -la ~/.local/share/mods/conversations/mods.db

# 如果数据库损坏，可以重建
rm ~/.local/share/mods/conversations/mods.db
# 下次运行时会自动重建

# 检查磁盘空间
df -h ~/.local/share/
```

---

## 4. 开发问题

### 4.1 编译问题

#### 问题: 编译错误

**症状**:
```
undefined: someFunction
或
cannot find package
```

**解决方案**:
```bash
# 整理依赖
go mod tidy

# 下载缺失依赖
go mod download

# 清理构建缓存
go clean -cache
go build .

# 检查导入路径
go list -m all | grep package-name
```

#### 问题: Lint 错误

**症状**:
```
golangci-lint run 发现问题
```

**解决方案**:
```bash
# 查看详细错误
golangci-lint run -v

# 自动修复
golangci-lint run --fix

# 格式化代码
gofmt -w .
goimports -w .

# 检查特定问题
golangci-lint run --disable-all --enable=errcheck
```

### 4.2 测试问题

#### 问题: 测试失败

**症状**:
```
--- FAIL: TestXXX
```

**解决方案**:
```bash
# 详细输出
go test -v ./...

# 运行特定测试
go test -v -run TestXXX ./...

# 检查测试依赖
go test -v -race ./...

# 更新 golden 文件
go test -v -run TestXXX -update ./...
```

#### 问题: 竞态条件

**症状**:
```
DATA RACE
```

**解决方案**:
```go
// 添加互斥锁保护共享数据
type SafeStruct struct {
    mu   sync.Mutex
    data map[string]string
}

func (s *SafeStruct) Set(key, value string) {
    s.mu.Lock()
    defer s.mu.Unlock()
    s.data[key] = value
}
```

---

## 5. MCP 问题

### 5.1 MCP 服务器问题

#### 问题: MCP 服务器连接失败

**症状**:
```
无法设置 xxx: context deadline exceeded
```

**解决方案**:
```bash
# 检查 MCP 服务器配置
mods --mcp-list

# 增加超时时间
# 在配置文件中设置:
# mcp-timeout: 30s

# 检查 Docker 容器状态（如果使用 Docker）
docker ps -a

# 手动测试 MCP 服务器
docker run -it --rm ghcr.io/github/github-mcp-server
```

#### 问题: MCP 工具调用失败

**症状**:
```
mcp: tool call failed
```

**解决方案**:
```bash
# 列出可用工具
mods --mcp-list-tools

# 检查工具配置
mods --settings

# 禁用特定 MCP 服务器
mods --mcp-disable github "你的提示"

# 检查环境变量
echo $GITHUB_PERSONAL_ACCESS_TOKEN
```

---

## 6. 性能问题

### 6.1 内存问题

#### 问题: 内存占用过高

**症状**:
程序占用大量内存

**解决方案**:
```bash
# 检查内存使用
top -p $(pgrep mods)

# 使用内存分析
go build -o mods .
./mods --memprofile

# 查看分析结果
go tool pprof mods_heap.profile
```

### 6.2 响应慢

#### 问题: 终端渲染慢

**症状**:
输出渲染卡顿

**解决方案**:
```bash
# 使用原始模式
mods --raw "你的提示"

# 减少花哨程度
mods --fanciness 0 "你的提示"

# 禁用格式化
mods --raw --no-format "你的提示"
```

---

## 7. 平台特定问题

### 7.1 Windows 问题

#### 问题: 命令找不到

**症状**:
```
'mods' 不是内部或外部命令
```

**解决方案**:
```powershell
# 检查 PATH
$env:PATH

# 添加 Go bin 目录
$env:PATH += ";$env:GOPATH\bin"

# 永久添加
[Environment]::SetEnvironmentVariable("PATH", $env:PATH + ";$env:GOPATH\bin", "User")
```

#### 问题: 权限错误

**症状**:
```
Access is denied
```

**解决方案**:
```powershell
# 以管理员身份运行
# 或修改文件权限
icacls mods.exe /grant Users:F
```

### 7.2 macOS 问题

#### 问题: 无法验证开发者

**症状**:
```
无法打开"mods"，因为无法验证开发者
```

**解决方案**:
```bash
# 允许运行
xattr -d com.apple.quarantine $(which mods)

# 或在系统偏好设置中允许
# 系统偏好设置 > 安全性与隐私 > 通用 > 仍要打开
```

### 7.3 Linux 问题

#### 问题: 共享库缺失

**症状**:
```
error while loading shared libraries: libc.so.6
```

**解决方案**:
```bash
# 检查依赖
ldd mods

# 安装缺失库
# Ubuntu/Debian
sudo apt install libc6

# Fedora
sudo dnf install glibc
```

---

## 8. 调试技巧

### 8.1 启用详细日志

```bash
# 设置调试环境变量
export MODS_DEBUG=1

# 查看配置
mods --dirs

# 查看原始响应
mods --raw "你的提示"
```

### 8.2 检查网络请求

```bash
# 使用代理查看请求
export HTTP_PROXY="http://localhost:8080"
export HTTPS_PROXY="http://localhost:8080"

# 使用 mitmproxy
mitmproxy --mode reverse:https://api.openai.com
```

### 8.3 数据库调试

```bash
# 检查数据库内容
sqlite3 ~/.local/share/mods/conversations/mods.db

# 查询对话
sqlite> SELECT * FROM conversations ORDER BY updated_at DESC LIMIT 10;

# 检查缓存文件
ls -la ~/.local/share/mods/conversations/*.gob
```

---

## 9. 错误代码参考

| 错误代码 | 说明 | 解决方案 |
|----------|------|----------|
| `E001` | 配置文件加载失败 | 检查配置文件格式 |
| `E002` | API 密钥无效 | 验证 API 密钥 |
| `E003` | 网络连接失败 | 检查网络或代理设置 |
| `E004` | 模型不存在 | 检查模型名称 |
| `E005` | 上下文超限 | 减少输入或使用更大上下文模型 |
| `E006` | 数据库错误 | 检查数据库文件权限 |
| `E007` | 缓存读写失败 | 检查缓存目录权限 |
| `E008` | MCP 服务器错误 | 检查 MCP 配置 |

---

## 10. 获取帮助

### 10.1 官方资源

- **GitHub Issues**: https://github.com/charmbracelet/mods/issues
- **文档**: 项目 docs 目录
- **社区**: Slack 或 Discord

### 10.2 报告问题

提交 Issue 时请包含：

1. **环境信息**:
   ```bash
   go version
   mods --version
   uname -a
   ```

2. **问题描述**: 详细描述问题

3. **复现步骤**: 如何复现问题

4. **错误信息**: 完整的错误输出

5. **配置信息**: 相关配置（隐藏敏感信息）

### 10.3 联系方式

- **项目维护者**: purpose168@outlook.com
- **GitHub**: https://github.com/charmbracelet/mods

---

## 附录

### A. 快速诊断清单

- [ ] Go 版本是否正确？
- [ ] 依赖是否完整？
- [ ] API 密钥是否配置？
- [ ] 网络是否正常？
- [ ] 配置文件是否有效？
- [ ] 磁盘空间是否充足？
- [ ] 权限是否正确？

### B. 相关文档

- [构建部署流程](../deployment/01-构建部署流程.md)
- [开发规范](../development/01-开发规范.md)
- [API 接口文档](../api/01-API接口文档.md)

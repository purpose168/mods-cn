# 构建部署流程

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-13
- **最后更新**: 2026-02-13
- **维护人员**: purpose168@outlook.com

---

## 1. 概述

本文档详细描述了 Mods 项目的构建和部署流程，包括开发环境配置、构建步骤、发布流程、环境变量配置等内容。

---

## 2. 环境要求

### 2.1 开发环境

| 组件 | 版本要求 | 说明 |
|------|----------|------|
| **Go** | 1.24.2+ | Go 编译器 |
| **Git** | 2.x | 版本控制 |
| **Make** | 任意版本 | 构建工具（可选） |

### 2.2 构建工具

| 工具 | 用途 |
|------|------|
| **golangci-lint** | 代码检查 |
| **goreleaser** | 跨平台构建和发布 |

### 2.3 操作系统支持

| 操作系统 | 架构 | 构建支持 |
|----------|------|----------|
| Linux | amd64, arm64 | ✅ |
| macOS | amd64 (Intel), arm64 (Apple Silicon) | ✅ |
| Windows | amd64, arm64 | ✅ |
| FreeBSD | amd64 | ✅ |

---

## 3. 本地开发环境配置

### 3.1 安装 Go

**Linux/macOS**:
```bash
# 使用官方安装脚本
wget https://go.dev/dl/go1.24.2.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.24.2.linux-amd64.tar.gz

# 配置环境变量
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
echo 'export GOPATH=$HOME/go' >> ~/.bashrc
echo 'export PATH=$PATH:$GOPATH/bin' >> ~/.bashrc
source ~/.bashrc
```

**使用包管理器**:
```bash
# macOS (Homebrew)
brew install go

# Ubuntu/Debian
sudo apt update
sudo apt install golang-go

# Arch Linux
sudo pacman -S go
```

### 3.2 克隆项目

```bash
# 克隆仓库
git clone https://github.com/charmbracelet/mods.git
cd mods

# 或使用中文版
git clone https://github.com/purpose168/mods-cn.git
cd mods-cn
```

### 3.3 安装依赖

```bash
# 下载依赖
go mod download

# 整理依赖
go mod tidy
```

### 3.4 安装开发工具

```bash
# 安装 golangci-lint
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# 安装 goreleaser
go install github.com/goreleaser/goreleaser/v2@latest
```

---

## 4. 构建流程

### 4.1 本地构建

#### 4.1.1 基本构建

```bash
# 构建当前平台版本
go build -o mods .

# 构建并安装到 $GOPATH/bin
go install .
```

#### 4.1.2 带版本信息构建

```bash
# 获取版本信息
VERSION=$(git describe --tags --always --dirty)
COMMIT=$(git rev-parse --short HEAD)

# 构建
go build -ldflags "-X main.Version=$VERSION -X main.CommitSHA=$COMMIT" -o mods .
```

#### 4.1.3 优化构建

```bash
# 减小二进制大小
go build -ldflags "-s -w" -o mods .

# 使用 UPX 进一步压缩（可选）
upx --best mods
```

### 4.2 跨平台构建

#### 4.2.1 手动交叉编译

```bash
# Linux amd64
GOOS=linux GOARCH=amd64 go build -o mods-linux-amd64 .

# Linux arm64
GOOS=linux GOARCH=arm64 go build -o mods-linux-arm64 .

# macOS amd64
GOOS=darwin GOARCH=amd64 go build -o mods-darwin-amd64 .

# macOS arm64
GOOS=darwin GOARCH=arm64 go build -o mods-darwin-arm64 .

# Windows amd64
GOOS=windows GOARCH=amd64 go build -o mods-windows-amd64.exe .
```

#### 4.2.2 使用 GoReleaser

```bash
# 本地测试构建
goreleaser build --snapshot --clean

# 完整构建（需要 Git 标签）
goreleaser build --clean
```

### 4.3 GoReleaser 配置

**配置文件**: [.goreleaser.yml](../../.goreleaser.yml)

```yaml
# 构建配置
builds:
  - env:
      - CGO_ENABLED=0
    goos:
      - linux
      - darwin
      - windows
      - freebsd
    goarch:
      - amd64
      - arm64
    ldflags:
      - -s -w -X main.Version={{.Version}} -X main.CommitSHA={{.Commit}}
    ignore:
      - goos: freebsd
        goarch: arm64

# 归档配置
archives:
  - format: tar.gz
    format_overrides:
      - goos: windows
        format: zip
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"

# 包管理器发布
brews:
  - name: mods
    repository:
      owner: charmbracelet
      name: homebrew-tap
```

---

## 5. 测试流程

### 5.1 运行测试

```bash
# 运行所有测试
go test ./...

# 运行测试并显示详细输出
go test -v ./...

# 运行特定包的测试
go test ./internal/cache/...

# 运行特定测试
go test -run TestEnsureConfig ./...
```

### 5.2 测试覆盖率

```bash
# 生成覆盖率报告
go test -cover ./...

# 生成详细覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# 查看覆盖率统计
go tool cover -func=coverage.out
```

### 5.3 基准测试

```bash
# 运行基准测试
go test -bench=. ./...

# 运行特定基准测试
go test -bench=BenchmarkCache ./internal/cache/...
```

### 5.4 代码检查

```bash
# 运行 golangci-lint
golangci-lint run

# 运行并自动修复
golangci-lint run --fix

# 只检查特定问题
golangci-lint run --disable-all --enable=errcheck,staticcheck
```

---

## 6. 发布流程

### 6.1 版本号规范

遵循语义化版本规范 (SemVer):

```
MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]

示例:
- v1.0.0      正式版本
- v1.1.0      新功能版本
- v1.1.1      Bug 修复版本
- v2.0.0      重大更新版本
- v1.0.0-beta.1  预发布版本
```

### 6.2 发布步骤

#### 6.2.1 准备发布

```bash
# 1. 确保在主分支
git checkout main
git pull origin main

# 2. 更新 CHANGELOG
# 编辑 CHANGELOG.md 记录变更

# 3. 运行完整测试
go test ./...
golangci-lint run

# 4. 构建测试
goreleaser build --snapshot --clean
```

#### 6.2.2 创建标签

```bash
# 创建带注释的标签
git tag -a v1.0.0 -m "Release v1.0.0"

# 推送标签到远程
git push origin v1.0.0
```

#### 6.2.3 自动发布

推送标签后，GitHub Actions 会自动：
1. 运行测试
2. 构建多平台二进制文件
3. 创建 GitHub Release
4. 发布到 Homebrew 等包管理器

### 6.3 GitHub Actions 工作流

**配置文件**: [.github/workflows/goreleaser.yml](../../.github/workflows/goreleaser.yml)

```yaml
name: goreleaser

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 7. 安装部署

### 7.1 包管理器安装

#### 7.1.1 Homebrew (macOS/Linux)

```bash
# 添加 tap
brew tap charmbracelet/tap

# 安装
brew install mods

# 更新
brew upgrade mods
```

#### 7.1.2 APT (Debian/Ubuntu)

```bash
# 添加仓库
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list

# 安装
sudo apt update
sudo apt install mods
```

#### 7.1.3 YUM/DNF (Fedora/RHEL)

```bash
# 添加仓库
echo '[charm]
name=Charm
baseurl=https://repo.charm.sh/yum/
enabled=1
gpgcheck=1
gpgkey=https://repo.charm.sh/yum/gpg.key' | sudo tee /etc/yum.repos.d/charm.repo

# 安装
sudo yum install mods
# 或
sudo dnf install mods
```

#### 7.1.4 AUR (Arch Linux)

```bash
# 使用 yay
yay -S mods

# 使用 paru
paru -S mods
```

#### 7.1.5 Winget (Windows)

```bash
winget install charmbracelet.mods
```

#### 7.1.6 Scoop (Windows)

```bash
scoop bucket add charm https://github.com/charmbracelet/scoop-bucket.git
scoop install mods
```

### 7.2 二进制安装

```bash
# 下载最新版本
# 访问 https://github.com/charmbracelet/mods/releases

# Linux/macOS
curl -sL https://github.com/charmbracelet/mods/releases/download/v1.0.0/mods_1.0.0_linux_amd64.tar.gz | tar xz
sudo mv mods /usr/local/bin/

# Windows (PowerShell)
# 下载 .zip 文件并解压
```

### 7.3 从源码安装

```bash
# 安装最新版本
go install github.com/charmbracelet/mods@latest

# 安装特定版本
go install github.com/charmbracelet/mods@v1.0.0

# 安装特定分支
go install github.com/charmbracelet/mods@main
```

---

## 8. 环境变量配置

### 8.1 API 密钥配置

```bash
# OpenAI
export OPENAI_API_KEY="sk-..."

# Anthropic
export ANTHROPIC_API_KEY="sk-ant-..."

# Cohere
export COHERE_API_KEY="..."

# Google
export GOOGLE_API_KEY="..."

# Groq
export GROQ_API_KEY="..."

# Azure OpenAI
export AZURE_OPENAI_KEY="..."
```

### 8.2 应用配置

```bash
# 默认 API
export MODS_API="openai"

# 默认模型
export MODS_MODEL="gpt-4o"

# 温度参数
export MODS_TEMP="1.0"

# 安静模式
export MODS_QUIET="true"

# 缓存路径
export MODS_CACHE_PATH="$HOME/.cache/mods"

# HTTP 代理
export MODS_HTTP_PROXY="http://proxy:8080"
```

### 8.3 持久化配置

**配置文件位置**:
- Linux: `~/.config/mods/mods.yml`
- macOS: `~/Library/Application Support/mods/mods.yml`
- Windows: `%APPDATA%\mods\mods.yml`

**编辑配置**:
```bash
# 打开配置文件编辑器
mods --settings
```

---

## 9. CI/CD 配置

### 9.1 GitHub Actions 工作流

#### 9.1.1 构建工作流

**文件**: [.github/workflows/build.yml](../../.github/workflows/build.yml)

```yaml
name: build

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Build
        run: go build -v ./...
      
      - name: Test
        run: go test -v ./...
```

#### 9.1.2 Lint 工作流

**文件**: [.github/workflows/lint.yml](../../.github/workflows/lint.yml)

```yaml
name: lint

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - uses: golangci/golangci-lint-action@v4
```

### 9.2 本地 CI 模拟

```bash
# 运行所有检查
make ci

# 或手动执行
go test ./...
golangci-lint run
go build ./...
```

---

## 10. 故障排除

### 10.1 常见构建问题

#### 问题: Go 版本不兼容

```bash
# 检查 Go 版本
go version

# 更新 Go
# 参考 3.1 节安装步骤
```

#### 问题: 依赖下载失败

```bash
# 设置代理（中国大陆）
go env -w GOPROXY=https://goproxy.cn,direct

# 清理缓存
go clean -modcache

# 重新下载
go mod download
```

#### 问题: 构建时内存不足

```bash
# 限制并行编译数
go build -p 1 .

# 或设置环境变量
export GOMAXPROCS=1
```

### 10.2 运行时问题

#### 问题: 找不到命令

```bash
# 检查 PATH
echo $PATH

# 添加 Go bin 目录
export PATH=$PATH:$(go env GOPATH)/bin
```

#### 问题: 权限错误

```bash
# 赋予执行权限
chmod +x mods

# 或使用 sudo 安装
sudo mv mods /usr/local/bin/
```

---

## 附录

### A. Makefile 示例

```makefile
.PHONY: all build test lint clean install

VERSION := $(shell git describe --tags --always --dirty)
COMMIT := $(shell git rev-parse --short HEAD)

all: lint test build

build:
	go build -ldflags "-X main.Version=$(VERSION) -X main.CommitSHA=$(COMMIT)" -o mods .

test:
	go test -v -race ./...

lint:
	golangci-lint run

clean:
	rm -f mods
	go clean

install:
	go install -ldflags "-X main.Version=$(VERSION) -X main.CommitSHA=$(COMMIT)" .

ci: lint test
	go build -v ./...
```

### B. 相关文档

- [开发规范](../development/01-开发规范.md)
- [测试策略](../testing/01-测试策略.md)
- [常见问题解决方案](../guides/01-常见问题解决方案.md)

### C. 外部资源

- [Go 安装指南](https://go.dev/doc/install)
- [GoReleaser 文档](https://goreleaser.com/)
- [GitHub Actions 文档](https://docs.github.com/en/actions)

# 数据流程文档

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-13
- **最后更新**: 2026-02-13
- **维护人员**: purpose168@outlook.com

---

## 1. 概述

本文档详细描述了 Mods 项目中的数据流转过程，包括用户输入处理、消息构建、API 请求、响应处理、缓存管理等关键业务流程。

---

## 2. 整体数据流

### 2.1 主流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  命令行参数 │───→│  配置加载   │───→│  终端检测   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  标准输入   │───→│  消息构建   │───→│  上下文设置 │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  模型选择   │───→│  API 客户端 │───→│  流式请求   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  响应接收   │───→│  内容渲染   │───→│  终端输出   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐    ┌─────────────┐                                     │
│  │  对话缓存   │───→│  数据库存储 │                                     │
│  └─────────────┘    └─────────────┘                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 详细数据流程

### 3.1 启动与初始化流程

```
程序启动
    │
    ├── main() 函数执行
    │       │
    │       ├── buildVersion() ──────────────────→ 构建版本信息
    │       │
    │       ├── ensureConfig() ──────────────────→ 加载配置文件
    │       │       │
    │       │       ├── 检查配置文件是否存在
    │       │       │       └── 不存在 → createConfigFile()
    │       │       │
    │       │       ├── 读取配置文件 (YAML)
    │       │       │
    │       │       ├── 解析环境变量 (MODS_*)
    │       │       │
    │       │       └── 返回 Config 结构
    │       │
    │       ├── initFlags() ─────────────────────→ 注册命令行标志
    │       │
    │       ├── openDB() ────────────────────────→ 打开 SQLite 数据库
    │       │       │
    │       │       ├── 创建数据库连接
    │       │       │
    │       │       ├── 创建 conversations 表
    │       │       │
    │       │       └── 创建索引
    │       │
    │       └── rootCmd.Execute() ───────────────→ 执行 Cobra 命令
    │
    └── 进入 RunE() 主逻辑
```

### 3.2 用户输入处理流程

```
用户输入处理
    │
    ├── 检测输入源
    │       │
    │       ├── isInputTTY() == true
    │       │       │
    │       │       ├── 检查是否有参数
    │       │       │       │
    │       │       │       ├── 有参数 → config.Prefix = args
    │       │       │       │
    │       │       │       └── 无参数 → askInfo() 交互式询问
    │       │       │               │
    │       │       │               ├── 选择 API
    │       │       │               │
    │       │       │               ├── 选择模型
    │       │       │               │
    │       │       │               └── 输入提示
    │       │       │
    │       │       └── 检查是否打开编辑器
    │       │               └── --editor → prefixFromEditor()
    │       │
    │       └── isInputTTY() == false
    │               │
    │               └── readStdinCmd() 读取标准输入
    │                       │
    │                       ├── io.ReadAll(os.Stdin)
    │                       │
    │                       └── increaseIndent() 增加缩进
    │
    └── 返回 completionInput 消息
```

### 3.3 消息构建流程

```
消息构建 (setupStreamContext)
    │
    ├── 初始化消息列表
    │       │
    │       └── m.messages = []proto.Message{}
    │
    ├── 添加格式化系统消息 (可选)
    │       │
    │       └── if config.Format && config.FormatText != ""
    │               │
    │               └── 添加 system 消息
    │                       Message{Role: system, Content: formatText}
    │
    ├── 加载角色配置 (可选)
    │       │
    │       └── if config.Role != ""
    │               │
    │               ├── 从 config.Roles 获取角色定义
    │               │
    │               └── 遍历角色消息
    │                       └── 添加 system 消息
    │
    ├── 合并用户输入
    │       │
    │       ├── config.Prefix + "\n\n" + content
    │       │
    │       └── 检查长度限制
    │               │
    │               └── if !NoLimit && len > MaxChars
    │                       └── 截断内容
    │
    ├── 加载历史消息 (可选)
    │       │
    │       └── if !NoCache && cacheReadFromID != ""
    │               │
    │               └── cache.Read() 读取缓存
    │                       └── 追加到 messages
    │
    └── 添加用户消息
            │
            └── Message{Role: user, Content: content}
```

### 3.4 API 请求流程

```
API 请求 (startCompletionCmd)
    │
    ├── 解析模型配置
    │       │
    │       └── resolveModel(config)
    │               │
    │               ├── 遍历 config.APIs
    │               │
    │               ├── 匹配 API 名称
    │               │
    │               ├── 匹配模型名称或别名
    │               │
    │               └── 返回 API 和 Model 配置
    │
    ├── 验证 API 密钥
    │       │
    │       └── ensureKey(api, defaultEnv, docsURL)
    │               │
    │               ├── 检查 api.APIKey
    │               │
    │               ├── 检查环境变量 (api.APIKeyEnv)
    │               │
    │               ├── 执行命令获取 (api.APIKeyCmd)
    │               │
    │               └── 检查默认环境变量
    │
    ├── 创建客户端配置
    │       │
    │       ├── OpenAI: openai.Config{AuthToken, BaseURL}
    │       │
    │       ├── Anthropic: anthropic.Config{AuthToken, BaseURL}
    │       │
    │       ├── Cohere: cohere.Config{AuthToken, BaseURL}
    │       │
    │       ├── Google: google.Config{Model, AuthToken}
    │       │
    │       └── Ollama: ollama.Config{BaseURL}
    │
    ├── 配置 HTTP 代理 (可选)
    │       │
    │       └── if HTTPProxy != ""
    │               └── 设置 HTTP 客户端代理
    │
    ├── 获取 MCP 工具 (可选)
    │       │
    │       └── mcpTools(ctx)
    │               │
    │               ├── 遍历启用的 MCP 服务器
    │               │
    │               ├── 初始化 MCP 客户端
    │               │
    │               └── 获取工具列表
    │
    ├── 构建请求
    │       │
    │       └── proto.Request{
    │               Messages: messages,
    │               Model: model,
    │               Temperature: temperature,
    │               TopP: topP,
    │               MaxTokens: maxTokens,
    │               Tools: tools,
    │           }
    │
    └── 发起流式请求
            │
            └── client.Request(ctx, request) → Stream
```

### 3.5 流式响应处理流程

```
流式响应处理 (receiveCompletionStreamCmd)
    │
    ├── 循环读取流
    │       │
    │       └── while stream.Next()
    │               │
    │               ├── stream.Current() 获取当前块
    │               │       │
    │               │       └── Chunk{Content: text}
    │               │
    │               ├── appendToOutput(content)
    │               │       │
    │               │       ├── 追加到 Output 字符串
    │               │       │
    │               │       └── 渲染 Markdown (glamour)
    │               │               │
    │               │               ├── 更新 glamOutput
    │               │               │
    │               │               └── 更新视口内容
    │               │
    │               └── 返回 completionOutput 消息
    │
    ├── 检查流错误
    │       │
    │       └── if stream.Err() != nil
    │               └── 返回错误消息
    │
    ├── 处理工具调用 (可选)
    │       │
    │       └── stream.CallTools()
    │               │
    │               ├── 遍历工具调用
    │               │
    │               ├── toolCall(ctx, name, data)
    │               │       │
    │               │       ├── 解析服务器和工具名
    │               │       │
    │               │       ├── 初始化 MCP 客户端
    │               │       │
    │               │       └── 执行工具调用
    │               │
    │               └── 返回工具调用状态
    │
    └── 获取最终消息
            │
            └── stream.Messages() → []proto.Message
```

### 3.6 对话缓存流程

```
对话缓存
    │
    ├── 查找缓存操作详情
    │       │
    │       └── findCacheOpsDetails()
    │               │
    │               ├── 确定 ReadID
    │               │       │
    │               │       ├── config.Continue
    │               │       │
    │               │       ├── config.Show
    │               │       │
    │               │       └── FindHEAD() 最新对话
    │               │
    │               ├── 确定 WriteID
    │               │       │
    │               │       ├── config.Title
    │               │       │
    │               │       ├── config.Continue
    │               │       │
    │               │       └── newConversationID() 新 ID
    │               │
    │               └── 返回 cacheDetailsMsg
    │
    ├── 读取缓存 (可选)
    │       │
    │       └── if cacheReadFromID != ""
    │               │
    │               └── cache.Read(id, &messages)
    │                       │
    │                       ├── 打开 .gob 文件
    │                       │
    │                       └── GOB 解码
    │
    └── 写入缓存
            │
            └── saveConversation(mods)
                    │
                    ├── 检查 NoCache 标志
                    │
                    ├── 确定对话标题
                    │       │
                    │       ├── 使用 config.Title
                    │       │
                    │       └── 使用最后提示的第一行
                    │
                    ├── cache.Write(id, &messages)
                    │       │
                    │       ├── 创建 .gob 文件
                    │       │
                    │       └── GOB 编码
                    │
                    └── db.Save(id, title, api, model)
                            │
                            ├── 更新现有记录
                            │
                            └── 或插入新记录
```

---

## 4. 数据结构流转

### 4.1 消息流转图

```
用户输入
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ string (原始文本)                                        │
│ "解释这段代码\n\npackage main..."                        │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ []proto.Message (消息列表)                               │
│ [                                                        │
│   {Role: "system", Content: "格式化为 markdown..."},    │
│   {Role: "system", Content: "你是 shell 专家..."},      │
│   {Role: "user", Content: "解释这段代码..."}             │
│ ]                                                        │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ proto.Request (API 请求)                                 │
│ {                                                        │
│   Messages: [...],                                       │
│   Model: "gpt-4o",                                       │
│   Temperature: 1.0,                                      │
│   MaxTokens: 100                                         │
│ }                                                        │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Stream (流式响应)                                        │
│ ─────────────────────────────────────────────────────── │
│ Chunk{Content: "这"}                                     │
│ Chunk{Content: "是一"}                                   │
│ Chunk{Content: "段"}                                     │
│ Chunk{Content: "Go"}                                     │
│ Chunk{Content: "代码"}                                   │
│ ...                                                      │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ string (输出文本)                                        │
│ "这是一段 Go 代码，实现了..."                             │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Markdown 渲染输出                                        │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 这是一段 Go 代码，实现了...                          │ │
│ │                                                     │ │
│ │ ```go                                               │ │
│ │ package main                                        │ │
│ │ ...                                                 │ │
│ │ ```                                                 │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 4.2 配置数据流

```
配置来源优先级
    │
    ├── 1. 命令行参数 (最高优先级)
    │       │
    │       └── --model gpt-4o --temp 0.5
    │
    ├── 2. 环境变量
    │       │
    │       └── MODS_MODEL=gpt-4o MODS_TEMP=0.5
    │
    └── 3. 配置文件 (最低优先级)
            │
            └── mods.yml
                    │
                    ├── default-api: openai
                    ├── default-model: gpt-4o
                    └── temp: 1.0
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Config 结构 (合并后的配置)                               │
│ {                                                        │
│   API: "openai",                                         │
│   Model: "gpt-4o",                                       │
│   Temperature: 0.5,                                      │
│   APIs: [...],                                           │
│   Roles: {...}                                           │
│ }                                                        │
└─────────────────────────────────────────────────────────┘
```

---

## 5. 关键业务场景

### 5.1 新对话场景

```
1. 用户输入: mods "什么是 Go？"
        │
        ▼
2. 参数解析: config.Prefix = "什么是 Go？"
        │
        ▼
3. 消息构建:
   messages = [
     {Role: user, Content: "什么是 Go？"}
   ]
        │
        ▼
4. 生成对话 ID: newConversationID() → "abc123..."
        │
        ▼
5. API 请求: OpenAI Chat Completion
        │
        ▼
6. 流式响应: 逐字输出
        │
        ▼
7. 保存对话:
   - cache.Write("abc123...", messages)
   - db.Save("abc123...", "什么是 Go？", "openai", "gpt-4o")
```

### 5.2 继续对话场景

```
1. 用户输入: mods -c "什么是 Go？" "还有其他特性吗？"
        │
        ▼
2. 查找对话: db.Find("什么是 Go？") → ID: "abc123..."
        │
        ▼
3. 读取缓存: cache.Read("abc123...", &messages)
   messages = [
     {Role: user, Content: "什么是 Go？"},
     {Role: assistant, Content: "Go 是..."},
     {Role: user, Content: "还有其他特性吗？"}
   ]
        │
        ▼
4. API 请求: 包含完整历史
        │
        ▼
5. 流式响应: 逐字输出
        │
        ▼
6. 更新对话:
   - cache.Write("abc123...", messages)
   - db.Save("abc123...", "什么是 Go？", ...)
```

### 5.3 工具调用场景

```
1. 用户输入: mods "查看今天的天气"
        │
        ▼
2. 消息构建 + MCP 工具
        │
        ▼
3. API 请求: 包含工具定义
        │
        ▼
4. AI 响应: 请求调用工具
   ToolCall: {name: "weather_get", arguments: {...}}
        │
        ▼
5. 工具执行: toolCall(ctx, "weather_get", data)
        │
        ▼
6. 工具结果: "今天晴天，温度 25°C"
        │
        ▼
7. 继续请求: 包含工具结果
        │
        ▼
8. 最终响应: "根据查询，今天天气..."
```

---

## 6. 数据持久化

### 6.1 SQLite 数据库

**存储内容**: 对话元数据

```sql
-- 表结构
CREATE TABLE conversations (
    id string NOT NULL PRIMARY KEY,      -- SHA-1 对话 ID
    title string NOT NULL,               -- 对话标题
    updated_at datetime NOT NULL,        -- 更新时间
    model string,                        -- 使用的模型
    api string                           -- 使用的 API
);

-- 索引
CREATE INDEX idx_conv_id ON conversations (id);
CREATE INDEX idx_conv_title ON conversations (title);
```

### 6.2 文件缓存

**存储内容**: 完整对话消息

```
~/.local/share/mods/
└── conversations/
    ├── abc123...abc.gob  # 对话消息 (GOB 格式)
    ├── def456...def.gob
    └── ...
```

**GOB 格式**:
```go
// 编码
gob.NewEncoder(file).Encode([]proto.Message{...})

// 解码
gob.NewDecoder(file).Decode(&messages)
```

---

## 7. 并发与同步

### 7.1 并发场景

```
┌─────────────────────────────────────────────────────────┐
│                    主协程 (Bubble Tea)                   │
└─────────────────────────────────────────────────────────┘
        │
        ├── 启动 ──────────────────────────────────────→ UI 事件循环
        │
        ├── readStdinCmd ─────────────────────────────→ 读取输入协程
        │
        ├── startCompletionCmd ───────────────────────→ API 请求协程
        │       │
        │       └── mcpTools ─────────────────────────→ 并发获取 MCP 工具
        │               │
        │               ├── errgroup.Go ─────────────→ MCP 服务器 1
        │               ├── errgroup.Go ─────────────→ MCP 服务器 2
        │               └── errgroup.Go ─────────────→ MCP 服务器 N
        │
        └── receiveCompletionStreamCmd ───────────────→ 流处理协程
```

### 7.2 同步机制

```go
// 互斥锁保护共享数据
type Mods struct {
    content      []string
    contentMutex *sync.Mutex
}

// 写入时加锁
func (m *Mods) appendToOutput(s string) {
    m.contentMutex.Lock()
    m.content = append(m.content, s)
    m.contentMutex.Unlock()
}

// 并发获取 MCP 工具
func mcpTools(ctx context.Context) (map[string][]mcp.Tool, error) {
    var mu sync.Mutex
    var wg errgroup.Group
    result := map[string][]mcp.Tool{}
    
    for sname, server := range enabledMCPs() {
        wg.Go(func() error {
            tools, err := mcpToolsFor(ctx, sname, server)
            mu.Lock()
            result[sname] = tools
            mu.Unlock()
            return err
        })
    }
    
    return result, wg.Wait()
}
```

---

## 8. 错误处理流程

### 8.1 错误传播

```
错误发生
    │
    ├── API 错误
    │       │
    │       ├── 网络错误 → 重试机制
    │       │
    │       ├── 认证错误 → 提示设置 API 密钥
    │       │
    │       └── 上下文超限 → 裁剪提示重试
    │
    ├── 配置错误
    │       │
    │       ├── 文件不存在 → 创建默认配置
    │       │
    │       └── 格式错误 → 显示错误信息
    │
    └── 用户错误
            │
            └── 无效参数 → 显示帮助信息
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ modsError 结构                                           │
│ {                                                        │
│   err: originalError,                                    │
│   reason: "用户友好的错误描述"                            │
│ }                                                        │
└─────────────────────────────────────────────────────────┘
    │
    ▼
handleError(err) → 格式化输出到 stderr
```

### 8.2 重试机制

```go
// 指数退避重试
func (m *Mods) retry(content string, err modsError) tea.Msg {
    m.retries++
    
    if m.retries >= m.Config.MaxRetries {
        return err  // 达到最大重试次数
    }
    
    // 指数退避等待
    wait := time.Millisecond * 100 * time.Duration(math.Pow(2, float64(m.retries)))
    time.Sleep(wait)
    
    return completionInput{content}  // 重试
}
```

---

## 附录

### A. 相关文档

- [项目架构概述](../architecture/01-项目架构概述.md)
- [模块划分](../architecture/03-模块划分.md)
- [API 接口文档](./01-API接口文档.md)

### B. 流程图工具

本文档中的流程图使用 Mermaid 语法绘制，可使用以下工具渲染：
- [Mermaid Live Editor](https://mermaid.live/)
- VS Code Mermaid 插件
- GitHub Markdown 渲染

# 模块划分

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-13
- **最后更新**: 2026-02-13
- **维护人员**: purpose168@outlook.com

---

## 1. 概述

Mods 项目采用模块化设计，将功能划分为多个独立的模块，每个模块负责特定的功能领域。本文档详细说明了项目的模块划分、各模块职责以及模块间的交互关系。

---

## 2. 模块总览

### 2.1 目录结构

```
mods-cn/
├── main.go              # 主程序入口
├── mods.go              # 核心模型和业务逻辑
├── config.go            # 配置管理
├── db.go                # 数据库操作
├── mcp.go               # MCP 协议集成
├── messages.go          # 消息处理
├── stream.go            # 流上下文设置
├── error.go             # 错误处理
├── styles.go            # 终端样式
├── anim.go              # 动画效果
├── term.go              # 终端检测
├── flag.go              # 命令行标志
├── load.go              # 加载功能
├── sha.go               # SHA-1 生成
├── examples.go          # 示例管理
├── internal/            # 内部模块
│   ├── cache/           # 缓存模块
│   ├── openai/          # OpenAI 客户端
│   ├── anthropic/       # Anthropic 客户端
│   ├── cohere/          # Cohere 客户端
│   ├── google/          # Google 客户端
│   ├── ollama/          # Ollama 客户端
│   ├── proto/           # 协议定义
│   └── stream/          # 流接口定义
└── docs/                # 项目文档
```

### 2.2 模块分类

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层模块                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │ main.go │ │mods.go  │ │config.go│ │ error.go│           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      功能层模块                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │  db.go  │ │  mcp.go │ │stream.go│ │messages.│           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │styles.go│ │ anim.go │ │ term.go │ │ flag.go │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      内部模块                                │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │  cache  │ │  proto  │ │ stream  │ │  openai │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │anthropic│ │ cohere  │ │ google  │ │ ollama  │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 应用层模块

### 3.1 主程序模块 (main.go)

**职责**: 应用程序入口和命令行处理

**核心功能**:
- 初始化配置和数据库
- 注册命令行标志和参数
- 启动 Bubble Tea 应用程序
- 处理用户交互流程

**主要函数**:

| 函数名 | 说明 |
|--------|------|
| `main()` | 程序入口点 |
| `initFlags()` | 初始化命令行标志 |
| `buildVersion()` | 构建版本信息 |
| `handleError()` | 错误处理和显示 |
| `askInfo()` | 交互式信息询问 |
| `listConversations()` | 列出对话 |
| `deleteConversations()` | 删除对话 |
| `saveConversation()` | 保存对话 |

**依赖模块**:
- `config.go` - 配置管理
- `mods.go` - 核心模型
- `db.go` - 数据库操作
- `styles.go` - 样式渲染

### 3.2 核心模型模块 (mods.go)

**职责**: 核心业务逻辑和状态管理

**核心结构**:

```go
// Mods 是 Bubble Tea 模型
type Mods struct {
    Output        string              // 输出内容
    Input         string              // 输入内容
    Styles        styles              // 样式配置
    Error         *modsError          // 错误信息
    state         state               // 当前状态
    messages      []proto.Message     // 消息列表
    db            *convoDB            // 数据库
    cache         *cache.Conversations // 缓存
    Config        *Config             // 配置
}
```

**状态定义**:

| 状态 | 说明 |
|------|------|
| `startState` | 起始状态 |
| `configLoadedState` | 配置加载完成 |
| `requestState` | 请求状态 |
| `responseState` | 响应状态 |
| `doneState` | 完成状态 |
| `errorState` | 错误状态 |

**主要方法**:

| 方法名 | 说明 |
|--------|------|
| `Init()` | 初始化模型 |
| `Update()` | 处理消息更新 |
| `View()` | 渲染视图 |
| `startCompletionCmd()` | 启动补全请求 |
| `resolveModel()` | 解析模型配置 |
| `ensureKey()` | 确保 API 密钥可用 |

### 3.3 配置管理模块 (config.go)

**职责**: 配置加载和管理

**核心结构**:

```go
// Config 主配置结构
type Config struct {
    API                 string     // 默认 API
    Model               string     // 默认模型
    Format              bool       // 格式化输出
    FormatText          FormatText // 格式化文本
    MaxTokens           int64      // 最大令牌数
    Temperature         float64    // 温度参数
    APIs                APIs       // API 列表
    Roles               map[string][]string // 角色
    MCPServers          map[string]MCPServerConfig // MCP 服务器
    // ... 更多配置
}

// API API 端点配置
type API struct {
    Name      string
    APIKey    string
    BaseURL   string
    Models    map[string]Model
}

// Model 模型配置
type Model struct {
    Name           string
    MaxChars       int64
    Aliases        []string
    Fallback       string
}
```

**主要函数**:

| 函数名 | 说明 |
|--------|------|
| `ensureConfig()` | 确保配置文件存在 |
| `defaultConfig()` | 获取默认配置 |
| `writeConfigFile()` | 写入配置文件 |

### 3.4 错误处理模块 (error.go)

**职责**: 统一错误处理

**核心结构**:

```go
// modsError 自定义错误类型
type modsError struct {
    err    error  // 原始错误
    reason string // 错误原因
}
```

**错误类型**:
- `modsError` - 应用程序错误
- `flagParseError` - 标志解析错误
- `newUserErrorf` - 用户错误

---

## 4. 功能层模块

### 4.1 数据库模块 (db.go)

**职责**: 对话数据的持久化存储

**核心结构**:

```go
// convoDB 对话数据库
type convoDB struct {
    db *sqlx.DB
}

// Conversation 对话记录
type Conversation struct {
    ID        string    // 对话 ID
    Title     string    // 标题
    UpdatedAt time.Time // 更新时间
    API       *string   // API 名称
    Model     *string   // 模型名称
}
```

**主要方法**:

| 方法名 | 说明 |
|--------|------|
| `openDB()` | 打开数据库连接 |
| `Save()` | 保存对话 |
| `Delete()` | 删除对话 |
| `Find()` | 查找对话 |
| `List()` | 列出所有对话 |
| `FindHEAD()` | 查找最新对话 |
| `Completions()` | 获取自动补全列表 |

### 4.2 MCP 集成模块 (mcp.go)

**职责**: Model Context Protocol 服务器集成

**核心结构**:

```go
// MCPServerConfig MCP 服务器配置
type MCPServerConfig struct {
    Type    string   // 类型: stdio, sse, http
    Command string   // 命令
    Env     []string // 环境变量
    Args    []string // 参数
    URL     string   // URL (用于 sse/http)
}
```

**主要函数**:

| 函数名 | 说明 |
|--------|------|
| `enabledMCPs()` | 获取已启用的 MCP 服务器 |
| `mcpList()` | 列出 MCP 服务器 |
| `mcpListTools()` | 列出 MCP 工具 |
| `mcpTools()` | 获取所有 MCP 工具 |
| `initMcpClient()` | 初始化 MCP 客户端 |
| `toolCall()` | 调用工具 |

### 4.3 消息处理模块 (messages.go)

**职责**: 对话消息的处理

**主要函数**:

| 函数名 | 说明 |
|--------|------|
| `lastPrompt()` | 获取最后的用户提示 |
| `firstLine()` | 获取字符串第一行 |

### 4.4 流上下文模块 (stream.go)

**职责**: 设置流式请求的上下文

**主要方法**:

| 方法名 | 说明 |
|--------|------|
| `setupStreamContext()` | 设置流上下文 |

**处理流程**:
1. 添加格式化系统消息
2. 加载角色配置
3. 合并用户输入
4. 检查输入长度限制
5. 从缓存读取历史消息
6. 构建最终消息列表

### 4.5 样式模块 (styles.go)

**职责**: 终端输出样式定义

**样式类型**:
- `stdoutStyles()` - 标准输出样式
- `stderrStyles()` - 标准错误样式
- `makeStyles()` - 创建样式配置

### 4.6 动画模块 (anim.go)

**职责**: 加载动画效果

**动画类型**:
- 旋转器动画
- 进度指示器
- 状态文本显示

### 4.7 终端检测模块 (term.go)

**职责**: 检测终端环境

**主要函数**:

| 函数名 | 说明 |
|--------|------|
| `isInputTTY()` | 检测输入是否为 TTY |
| `isOutputTTY()` | 检测输出是否为 TTY |

### 4.8 标志解析模块 (flag.go)

**职责**: 自定义命令行标志解析

**核心类型**:
- `durationFlag` - 持续时间标志
- `flagParseError` - 标志解析错误

---

## 5. 内部模块

### 5.1 缓存模块 (internal/cache)

**职责**: 文件缓存管理

**核心结构**:

```go
// Cache 泛型缓存
type Cache[T any] struct {
    baseDir string
    cType   Type
}

// Conversations 对话缓存
type Conversations struct {
    *Cache[[]proto.Message]
}
```

**缓存类型**:
- `ConversationCache` - 对话缓存
- `TemporaryCache` - 临时缓存

**主要方法**:

| 方法名 | 说明 |
|--------|------|
| `New()` | 创建缓存实例 |
| `Read()` | 读取缓存 |
| `Write()` | 写入缓存 |
| `Delete()` | 删除缓存 |

### 5.2 协议模块 (internal/proto)

**职责**: 统一的消息协议定义

**核心结构**:

```go
// Message 消息结构
type Message struct {
    Role    Role   // 角色: system, user, assistant
    Content string // 内容
}

// Role 消息角色
type Role string

const (
    RoleSystem    Role = "system"
    RoleUser      Role = "user"
    RoleAssistant Role = "assistant"
)

// Request 请求结构
type Request struct {
    Messages    []Message
    Model       string
    Temperature *float64
    TopP        *float64
    MaxTokens   *int64
    Tools       map[string][]mcp.Tool
}

// Chunk 响应块
type Chunk struct {
    Content string
}
```

### 5.3 流接口模块 (internal/stream)

**职责**: 定义流式响应接口

**核心接口**:

```go
// Client 流客户端接口
type Client interface {
    Request(ctx context.Context, req proto.Request) Stream
}

// Stream 流接口
type Stream interface {
    Next() bool
    Current() (proto.Chunk, error)
    Err() error
    Close() error
    Messages() []proto.Message
    CallTools() []proto.ToolCallStatus
}
```

### 5.4 OpenAI 客户端模块 (internal/openai)

**职责**: OpenAI API 集成

**核心结构**:

```go
// Client OpenAI 客户端
type Client struct {
    *openai.Client
}

// Stream OpenAI 流
type Stream struct {
    stream   *ssestream.Stream[openai.ChatCompletionChunk]
    request  openai.ChatCompletionNewParams
    messages []proto.Message
}
```

**支持功能**:
- 流式聊天补全
- 工具调用
- JSON 响应格式
- Azure OpenAI 支持

### 5.5 Anthropic 客户端模块 (internal/anthropic)

**职责**: Anthropic Claude API 集成

**核心结构**:

```go
// Client Anthropic 客户端
type Client struct {
    *anthropic.Client
}

// Stream Anthropic 流
type Stream struct {
    stream   *ssestream.Stream[anthropic.MessageStreamEventUnion]
    request  anthropic.MessageNewParams
    messages []proto.Message
}
```

**支持功能**:
- Claude 系列模型
- 系统消息
- 工具调用
- 流式响应

### 5.6 Cohere 客户端模块 (internal/cohere)

**职责**: Cohere API 集成

**支持模型**:
- Command-R
- Command-R-Plus

### 5.7 Google 客户端模块 (internal/google)

**职责**: Google Gemini API 集成

**支持模型**:
- Gemini 1.5 Pro
- Gemini 1.5 Flash
- Gemini 2.0 Flash

**特殊功能**:
- Thinking Budget（思考预算）

### 5.8 Ollama 客户端模块 (internal/ollama)

**职责**: Ollama 本地模型集成

**特点**:
- 本地运行
- 无需 API 密钥
- 支持自定义模型

---

## 6. 模块间交互

### 6.1 请求处理流程

```
┌─────────────┐
│   main.go   │
│  (用户输入) │
└──────┬──────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│  config.go  │ ←── │  term.go    │
│ (加载配置)  │     │ (检测终端)  │
└──────┬──────┘     └─────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│   mods.go   │ ←── │  stream.go  │
│ (状态管理)  │     │ (设置上下文)│
└──────┬──────┘     └─────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│  proto/     │ ←── │  openai/    │
│ (消息协议)  │     │ anthropic/  │
└──────┬──────┘     │ cohere/...  │
       │            └─────────────┘
       ▼
┌─────────────┐
│   db.go     │     ┌─────────────┐
│  (保存对话) │ ←── │  cache/     │
└─────────────┘     │ (缓存消息)  │
                    └─────────────┘
```

### 6.2 配置加载流程

```
┌─────────────┐
│  main.go    │
│  (启动)     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ ensureConfig│
└──────┬──────┘
       │
       ├─────────────────┐
       │                 │
       ▼                 ▼
┌─────────────┐   ┌─────────────┐
│ YAML 文件   │   │ 环境变量    │
│ (mods.yml)  │   │ (MODS_*)    │
└──────┬──────┘   └──────┬──────┘
       │                 │
       └────────┬────────┘
                │
                ▼
         ┌─────────────┐
         │ Config 结构 │
         └─────────────┘
```

### 6.3 MCP 工具调用流程

```
┌─────────────┐
│   mods.go   │
│ (AI 响应)   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   mcp.go    │
│ (工具调用)  │
└──────┬──────┘
       │
       ├─────────────────┐
       │                 │
       ▼                 ▼
┌─────────────┐   ┌─────────────┐
│ stdio 客户端│   │ SSE 客户端  │
└──────┬──────┘   └──────┬──────┘
       │                 │
       └────────┬────────┘
                │
                ▼
         ┌─────────────┐
         │ MCP 服务器  │
         │ (工具执行)  │
         └─────────────┘
```

---

## 7. 模块依赖关系

### 7.1 依赖矩阵

| 模块 | main | mods | config | db | mcp | cache | proto | stream | openai | anthropic |
|------|------|------|--------|-----|-----|-------|-------|--------|--------|-----------|
| main | - | ✓ | ✓ | ✓ | ✓ | - | - | - | - | - |
| mods | - | - | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| config | - | - | - | - | - | - | - | - | - | - |
| db | - | - | - | - | - | - | - | - | - | - |
| mcp | - | - | ✓ | - | - | - | - | - | - | - |
| cache | - | - | - | - | - | - | ✓ | - | - | - |
| proto | - | - | - | - | - | - | - | - | - | - |
| stream | - | - | - | - | - | - | ✓ | - | - | - |
| openai | - | - | - | - | - | - | ✓ | ✓ | - | - |
| anthropic | - | - | - | - | - | - | ✓ | ✓ | - | - |

### 7.2 循环依赖避免

项目通过以下方式避免循环依赖：
1. 使用接口抽象（`stream.Stream` 接口）
2. 将共享类型放在 `proto` 包中
3. 使用依赖注入模式

---

## 8. 扩展指南

### 8.1 添加新的 AI 服务提供商

1. 在 `internal/` 目录创建新包
2. 实现 `stream.Client` 和 `stream.Stream` 接口
3. 在 `mods.go` 中添加初始化逻辑
4. 在配置模板中添加 API 配置

### 8.2 添加新的缓存后端

1. 在 `internal/cache` 中实现新的缓存类型
2. 保持与现有接口兼容

### 8.3 添加新的命令

1. 在 `main.go` 中定义新的 `cobra.Command`
2. 实现命令处理逻辑

---

## 附录

### A. 相关文档

- [项目架构概述](./01-项目架构概述.md)
- [技术栈说明](./02-技术栈说明.md)
- [接口定义](../api/01-API接口文档.md)

### B. 代码位置索引

| 功能 | 文件位置 |
|------|----------|
| 主入口 | [main.go](../../main.go) |
| 核心模型 | [mods.go](../../mods.go) |
| 配置管理 | [config.go](../../config.go) |
| 数据库操作 | [db.go](../../db.go) |
| MCP 集成 | [mcp.go](../../mcp.go) |
| 缓存模块 | [internal/cache/cache.go](../../internal/cache/cache.go) |
| 协议定义 | [internal/proto/proto.go](../../internal/proto/proto.go) |
| OpenAI 客户端 | [internal/openai/openai.go](../../internal/openai/openai.go) |
| Anthropic 客户端 | [internal/anthropic/anthropic.go](../../internal/anthropic/anthropic.go) |

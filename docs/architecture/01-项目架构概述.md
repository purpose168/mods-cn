# 项目架构概述

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-13
- **最后更新**: 2026-02-13
- **维护人员**: purpose168@outlook.com

---

## 1. 项目简介

**Mods** 是一个基于命令行的人工智能工具，专为管道操作而设计。它能够将大语言模型（LLM）的 AI 能力集成到命令行工作流中，支持多种 AI 服务提供商，包括 OpenAI、Anthropic、Cohere、Google Gemini、Ollama 等。

### 1.1 核心特性

- **多模型支持**: 支持 OpenAI、Anthropic Claude、Cohere、Google Gemini、Ollama 等多种 AI 模型
- **流式响应**: 实时流式输出 AI 响应内容
- **对话缓存**: 本地保存对话历史，支持会话恢复和继续
- **MCP 协议**: 支持 Model Context Protocol (MCP) 服务器集成
- **Markdown 渲染**: 终端中优雅渲染 Markdown 格式输出
- **角色系统**: 自定义系统提示角色，适配不同使用场景
- **管道友好**: 完美集成到 Unix 管道工作流中

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户界面层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   CLI 入口   │  │  交互式表单  │  │  终端渲染器  │          │
│  │   (main.go)  │  │    (huh)     │  │  (glamour)   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         应用核心层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 配置管理     │  │  消息处理    │  │  状态管理    │          │
│  │ (config.go)  │  │(messages.go) │  │  (mods.go)   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         服务集成层                               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  OpenAI  │ │Anthropic │ │  Cohere  │ │  Google  │           │
│  │ (openai) │ │(anthropic)│ │ (cohere) │ │ (google) │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │  Ollama  │ │  Azure   │ │   MCP    │                        │
│  │ (ollama) │ │  (azure) │ │  (mcp)   │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据存储层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  SQLite DB   │  │  文件缓存    │  │  配置文件    │          │
│  │   (db.go)    │  │   (cache)    │  │  (mods.yml)  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 架构层次说明

#### 2.2.1 用户界面层

负责与用户的交互，包括命令行参数解析、交互式表单、终端输出渲染等功能。

**核心组件**:
- **CLI 入口** (`main.go`): 使用 Cobra 框架处理命令行参数和子命令
- **交互式表单** (`huh`): 提供模型选择、提示输入等交互式界面
- **终端渲染器** (`glamour`): 将 Markdown 格式的 AI 响应渲染为终端友好的格式

#### 2.2.2 应用核心层

负责应用程序的核心业务逻辑，包括配置管理、消息处理、状态管理等。

**核心组件**:
- **配置管理** (`config.go`): 加载和管理用户配置，支持 YAML 配置文件和环境变量
- **消息处理** (`messages.go`): 处理对话消息的构建和管理
- **状态管理** (`mods.go`): 使用 Bubble Tea 框架管理应用程序状态和生命周期

#### 2.2.3 服务集成层

负责与各种 AI 服务提供商的 API 集成，实现统一的流式响应接口。

**核心组件**:
- **OpenAI 客户端** (`internal/openai`): OpenAI API 集成
- **Anthropic 客户端** (`internal/anthropic`): Anthropic Claude API 集成
- **Cohere 客户端** (`internal/cohere`): Cohere API 集成
- **Google 客户端** (`internal/google`): Google Gemini API 集成
- **Ollama 客户端** (`internal/ollama`): Ollama 本地模型集成
- **MCP 集成** (`mcp.go`): Model Context Protocol 服务器集成

#### 2.2.4 数据存储层

负责数据的持久化存储，包括对话历史、缓存和配置文件。

**核心组件**:
- **SQLite 数据库** (`db.go`): 存储对话元数据（ID、标题、时间戳等）
- **文件缓存** (`internal/cache`): 使用 GOB 格式存储完整对话内容
- **配置文件** (`config_template.yml`): YAML 格式的用户配置文件

---

## 3. 核心组件详解

### 3.1 主程序入口 (main.go)

主程序负责初始化配置、设置命令行参数、启动应用程序。

**主要职责**:
1. 初始化配置文件和数据库连接
2. 注册命令行标志和参数
3. 启动 Bubble Tea 应用程序
4. 处理用户交互和错误

**关键流程**:
```
main() 
  → ensureConfig()         // 确保配置文件存在
  → initFlags()            // 初始化命令行标志
  → openDB()               // 打开数据库连接
  → rootCmd.Execute()      // 执行 Cobra 命令
    → RunE()               // 运行主逻辑
      → askInfo()          // 交互式询问信息
      → newMods()          // 创建 Mods 实例
      → tea.NewProgram()   // 启动 Bubble Tea 程序
      → p.Run()            // 运行程序
```

### 3.2 核心模型 (mods.go)

`Mods` 结构体是应用程序的核心模型，实现了 Bubble Tea 的 `Model` 接口。

**状态流转**:
```
startState (起始状态)
    ↓
configLoadedState (配置加载完成)
    ↓
requestState (请求状态)
    ↓
responseState (响应状态)
    ↓
doneState (完成状态)
```

**主要方法**:
- `Init()`: 初始化模型，启动缓存查找
- `Update()`: 处理消息和状态更新
- `View()`: 渲染当前视图

### 3.3 配置系统 (config.go)

配置系统支持多种配置来源，按优先级从高到低：
1. 命令行参数
2. 环境变量（`MODS_` 前缀）
3. 配置文件（`mods.yml`）

**配置结构**:
```go
type Config struct {
    API                 string           // 默认 API
    Model               string           // 默认模型
    Format              bool             // 格式化输出
    FormatText          FormatText       // 格式化文本模板
    MaxTokens           int64            // 最大令牌数
    Temperature         float64          // 温度参数
    APIs                APIs             // API 配置列表
    Roles               map[string][]string // 角色定义
    MCPServers          map[string]MCPServerConfig // MCP 服务器配置
    // ... 更多配置项
}
```

### 3.4 数据库层 (db.go)

使用 SQLite 数据库存储对话元数据，支持对话的增删改查操作。

**数据库表结构**:
```sql
CREATE TABLE conversations (
    id string NOT NULL PRIMARY KEY,          -- 对话 ID (SHA-1)
    title string NOT NULL,                    -- 对话标题
    updated_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    model string,                             -- 使用的模型
    api string                                -- 使用的 API
)
```

**主要功能**:
- `Save()`: 保存或更新对话
- `Delete()`: 删除对话
- `Find()`: 查找对话
- `List()`: 列出所有对话
- `Completions()`: 获取自动补全列表

### 3.5 缓存系统 (internal/cache)

使用文件系统缓存完整的对话内容，采用 GOB 格式序列化。

**缓存类型**:
- `ConversationCache`: 对话缓存
- `TemporaryCache`: 临时缓存

**主要操作**:
- `Read()`: 读取缓存
- `Write()`: 写入缓存
- `Delete()`: 删除缓存

---

## 4. 数据流向

### 4.1 请求处理流程

```
用户输入
    ↓
读取标准输入/参数
    ↓
构建消息列表
    ↓
选择 API 和模型
    ↓
创建流式请求
    ↓
接收流式响应
    ↓
渲染输出
    ↓
保存对话缓存
```

### 4.2 对话缓存流程

```
新对话开始
    ↓
生成对话 ID (SHA-1)
    ↓
用户交互
    ↓
保存到文件缓存 (.gob)
    ↓
保存元数据到 SQLite
    ↓
继续对话时读取缓存
```

---

## 5. 关键技术决策

### 5.1 为什么选择 Bubble Tea？

Bubble Tea 是一个基于 Elm 架构的终端 UI 框架，具有以下优势：
- **声明式 UI**: 通过状态驱动的 UI 更新
- **并发安全**: 通过消息传递机制处理并发
- **可测试性**: 纯函数式的更新逻辑易于测试
- **可组合性**: 组件化的设计便于复用

### 5.2 为什么使用 SQLite？

- **轻量级**: 无需独立的数据库服务器
- **嵌入式**: 直接集成到应用程序中
- **高性能**: 对于小规模数据访问性能优异
- **可靠性**: 成熟稳定的关系型数据库

### 5.3 为什么采用流式响应？

- **实时反馈**: 用户可以立即看到 AI 的响应
- **降低延迟**: 无需等待完整响应生成
- **资源高效**: 逐步处理数据，减少内存占用
- **用户体验**: 提供更好的交互体验

---

## 6. 扩展性设计

### 6.1 添加新的 AI 服务提供商

要添加新的 AI 服务提供商，需要：

1. 在 `internal/` 目录下创建新的包（如 `internal/newprovider`）
2. 实现 `stream.Client` 接口
3. 实现 `stream.Stream` 接口
4. 在 `mods.go` 的 `startCompletionCmd` 方法中添加新的 case 分支
5. 在配置文件模板中添加相应的 API 配置

### 6.2 添加新的命令

使用 Cobra 框架添加新命令：

1. 在 `main.go` 中定义新的 `cobra.Command`
2. 使用 `rootCmd.AddCommand()` 注册命令
3. 实现命令的处理逻辑

### 6.3 添加新的输出格式

1. 在配置中添加新的格式类型
2. 在 `FormatText` 中添加对应的格式化提示
3. 在渲染器中添加相应的处理逻辑

---

## 7. 安全性考虑

### 7.1 API 密钥管理

- 支持从环境变量读取 API 密钥
- 支持通过命令获取 API 密钥（`api-key-cmd`）
- 配置文件中的 API 密钥字段可选

### 7.2 输入验证

- 对用户输入进行字符限制（`max-input-chars`）
- 防止上下文长度溢出

### 7.3 错误处理

- 统一的错误类型（`modsError`）
- 友好的错误提示信息
- 重试机制（`max-retries`）

---

## 8. 性能优化

### 8.1 并发处理

- 使用 `errgroup` 并发获取 MCP 工具列表
- 使用互斥锁保护共享数据

### 8.2 缓存策略

- 对话内容缓存到本地文件
- 数据库索引优化查询性能

### 8.3 流式处理

- 流式读取 AI 响应，减少内存占用
- 实时渲染输出，提升用户体验

---

## 9. 部署架构

### 9.1 单机部署

Mods 设计为单机命令行工具，无需服务器端部署。

```
用户终端
    ↓
Mods CLI
    ↓
AI API 服务
```

### 9.2 依赖项

- **运行时**: Go 1.24.2+
- **外部服务**: AI API 服务（OpenAI、Anthropic 等）
- **本地存储**: SQLite 数据库、文件系统缓存

---

## 10. 未来规划

### 10.1 短期目标

- 增加更多 AI 服务提供商支持
- 优化对话缓存机制
- 改进错误处理和重试策略

### 10.2 长期目标

- 支持多轮对话的上下文管理
- 集成更多 MCP 工具
- 提供插件系统支持自定义扩展

---

## 附录

### A. 相关文档

- [技术栈说明](./02-技术栈说明.md)
- [模块划分](./03-模块划分.md)
- [接口定义](../api/01-API接口文档.md)
- [开发规范](../development/01-开发规范.md)

### B. 参考资料

- [Bubble Tea 框架文档](https://github.com/charmbracelet/bubbletea)
- [Cobra 命令行框架](https://github.com/spf13/cobra)
- [OpenAI API 文档](https://platform.openai.com/docs)
- [Anthropic API 文档](https://docs.anthropic.com)

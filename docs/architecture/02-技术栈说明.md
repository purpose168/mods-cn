# 技术栈说明

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-13
- **最后更新**: 2026-02-13
- **维护人员**: purpose168@outlook.com

---

## 1. 概述

Mods 项目采用 Go 语言开发，是一个现代化的命令行工具，集成了多种前沿技术和框架。本文档详细说明了项目所使用的所有技术组件及其版本信息。

---

## 2. 核心技术栈

### 2.1 编程语言

| 技术 | 版本 | 用途 |
|------|------|------|
| **Go** | 1.24.2+ | 主要编程语言 |

**选择理由**:
- 高性能编译型语言，适合命令行工具开发
- 优秀的并发支持（goroutine 和 channel）
- 丰富的标准库和生态系统
- 跨平台编译能力
- 静态类型安全

---

## 3. 核心依赖库

### 3.1 命令行框架

| 库名 | 版本 | 用途 |
|------|------|------|
| **github.com/spf13/cobra** | v1.10.2 | 命令行应用框架 |
| **github.com/spf13/pflag** | v1.0.10 | POSIX/GNU 风格标志解析 |

**Cobra 框架特性**:
- 支持子命令嵌套
- 自动生成帮助文档
- 支持 shell 自动补全（Bash、Zsh、Fish、PowerShell）
- 灵活的标志解析
- 支持生成 man 手册页

### 3.2 终端 UI 框架

| 库名 | 版本 | 用途 |
|------|------|------|
| **github.com/charmbracelet/bubbletea** | v1.3.10 | 终端 UI 框架（Elm 架构） |
| **github.com/charmbracelet/bubbles** | v0.21.1 | Bubble Tea 组件库 |
| **github.com/charmbracelet/lipgloss** | v1.1.1-0.20250404203927-76690c660834 | 终端样式库 |
| **github.com/charmbracelet/huh** | v0.8.0 | 交互式表单库 |
| **github.com/charmbracelet/glamour** | v0.10.0 | Markdown 终端渲染 |
| **github.com/muesli/termenv** | v0.16.0 | 终端环境检测 |

**Bubble Tea 架构优势**:
- 基于 Elm 架构的函数式设计
- 消息驱动的状态管理
- 高度可组合的组件系统
- 优秀的并发处理能力

### 3.3 AI 服务 SDK

| 库名 | 版本 | 用途 |
|------|------|------|
| **github.com/openai/openai-go** | v1.12.0 | OpenAI API 客户端 |
| **github.com/anthropics/anthropic-sdk-go** | v1.22.0 | Anthropic Claude API 客户端 |
| **github.com/cohere-ai/cohere-go/v2** | v2.16.2 | Cohere API 客户端 |
| **github.com/ollama/ollama** | v0.15.6 | Ollama 本地模型客户端 |
| **github.com/mark3labs/mcp-go** | v0.43.2 | MCP 协议客户端 |

### 3.4 数据存储

| 库名 | 版本 | 用途 |
|------|------|------|
| **github.com/jmoiron/sqlx** | v1.4.0 | SQL 扩展库 |
| **modernc.org/sqlite** | v1.44.3 | 纯 Go SQLite 驱动 |

**SQLite 选择理由**:
- 无需独立数据库服务器
- 轻量级嵌入式数据库
- 单文件存储，便于备份和迁移
- 成熟稳定，广泛使用

### 3.5 配置管理

| 库名 | 版本 | 用途 |
|------|------|------|
| **gopkg.in/yaml.v3** | v3.0.1 | YAML 解析 |
| **github.com/caarlos0/env/v9** | v9.0.0 | 环境变量解析 |
| **github.com/adrg/xdg** | v0.5.3 | XDG 基础目录规范 |

### 3.6 工具库

| 库名 | 版本 | 用途 |
|------|------|------|
| **github.com/atotto/clipboard** | v0.1.4 | 剪贴板操作 |
| **github.com/caarlos0/duration** | - | 持续时间解析 |
| **github.com/caarlos0/go-shellwords** | v1.0.12 | Shell 命令解析 |
| **github.com/caarlos0/timea.go** | v1.2.0 | 时间格式化 |
| **github.com/lucasb-eyer/go-colorful** | v1.3.0 | 颜色处理 |
| **github.com/mattn/go-isatty** | v0.0.20 | TTY 检测 |
| **golang.org/x/sync** | v0.19.0 | 同步原语扩展 |

---

## 4. 开发工具依赖

### 4.1 测试框架

| 库名 | 版本 | 用途 |
|------|------|------|
| **github.com/stretchr/testify** | v1.11.1 | 测试断言和模拟 |
| **github.com/charmbracelet/x/exp/golden** | - | Golden 测试 |

### 4.2 代码质量

| 工具 | 配置文件 | 用途 |
|------|----------|------|
| **golangci-lint** | `.golangci.yml` | Go 代码检查工具 |

### 4.3 构建发布

| 工具 | 配置文件 | 用途 |
|------|----------|------|
| **GoReleaser** | `.goreleaser.yml` | 跨平台构建和发布 |

---

## 5. 支持的 AI 服务

### 5.1 商业 AI 服务

| 服务商 | API 类型 | 支持的模型 |
|--------|----------|------------|
| **OpenAI** | REST API | GPT-4o, GPT-4, GPT-3.5-turbo, o1, o3 系列 |
| **Anthropic** | REST API | Claude Sonnet 4, Claude Opus 4, Claude 3.5 Haiku |
| **Cohere** | REST API | Command-R, Command-R-Plus |
| **Google** | REST API | Gemini 1.5 Pro, Gemini 1.5 Flash, Gemini 2.0 Flash |
| **Groq** | REST API | Llama 3.3, Mixtral, Gemma 2 |
| **Perplexity** | REST API | Llama 3.1 Sonar 系列 |
| **Mistral** | REST API | Mistral Large, Mistral Nemo |
| **DeepSeek** | REST API | DeepSeek Chat, DeepSeek Reasoner |
| **Cerebras** | REST API | Llama 3.1 系列 |
| **SambaNova** | REST API | Llama 3.x, DeepSeek R1, Qwen 2.5 |

### 5.2 本地/开源模型

| 服务商 | 类型 | 支持的模型 |
|--------|------|------------|
| **Ollama** | 本地服务 | Llama 3.2 系列等 |
| **LocalAI** | 本地服务 | GPT4ALL-J 等 |

### 5.3 云平台

| 平台 | 说明 |
|------|------|
| **Azure OpenAI** | Microsoft Azure 托管的 OpenAI 服务 |
| **GitHub Models** | GitHub Marketplace 模型服务 |
| **RunPod** | GPU 云服务 |

---

## 6. 技术架构图

### 6.1 依赖关系图

```
┌─────────────────────────────────────────────────────────┐
│                      Mods CLI                           │
│                   (main.go, mods.go)                    │
└───────────────────────┬─────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│    Cobra     │ │ Bubble Tea   │ │   Config     │
│   (CLI 框架) │ │  (UI 框架)   │ │  (配置管理)  │
└──────────────┘ └──────────────┘ └──────────────┘
        │               │               │
        │               │               │
        └───────────────┼───────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   OpenAI     │ │  Anthropic   │ │   Cohere     │
│    SDK       │ │     SDK      │ │     SDK      │
└──────────────┘ └──────────────┘ └──────────────┘
        │               │               │
        └───────────────┼───────────────┘
                        │
                        ▼
              ┌──────────────────┐
              │   AI API 服务    │
              │ (OpenAI/Claude等)│
              └──────────────────┘
```

### 6.2 数据流架构

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  用户输入   │ ──→  │  消息构建   │ ──→  │  API 请求   │
│ (STDIN/参数)│      │ (messages)  │      │  (stream)   │
└─────────────┘      └─────────────┘      └─────────────┘
                                                 │
                                                 ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  终端输出   │ ←──  │  Markdown   │ ←──  │  流式响应   │
│  (glamour)  │      │   渲染      │      │  (chunks)   │
└─────────────┘      └─────────────┘      └─────────────┘
       │
       ▼
┌─────────────┐      ┌─────────────┐
│  对话缓存   │ ──→  │   SQLite    │
│   (.gob)    │      │   数据库    │
└─────────────┘      └─────────────┘
```

---

## 7. 版本兼容性

### 7.1 Go 版本要求

- **最低版本**: Go 1.24.2
- **推荐版本**: Go 1.24.x 或更高

### 7.2 操作系统支持

| 操作系统 | 架构 | 支持状态 |
|----------|------|----------|
| **Linux** | amd64, arm64 | ✅ 完全支持 |
| **macOS** | amd64, arm64 | ✅ 完全支持 |
| **Windows** | amd64, arm64 | ✅ 完全支持 |
| **FreeBSD** | amd64 | ✅ 完全支持 |

---

## 8. 第三方服务集成

### 8.1 API 认证方式

| 服务商 | 认证方式 | 环境变量 |
|--------|----------|----------|
| OpenAI | API Key | `OPENAI_API_KEY` |
| Anthropic | API Key | `ANTHROPIC_API_KEY` |
| Cohere | API Key | `COHERE_API_KEY` |
| Google | API Key | `GOOGLE_API_KEY` |
| Groq | API Key | `GROQ_API_KEY` |
| Azure | API Key | `AZURE_OPENAI_KEY` |
| Perplexity | API Key | `PERPLEXITY_API_KEY` |
| Mistral | API Key | `MISTRAL_API_KEY` |
| DeepSeek | API Key | `DEEPSEEK_API_KEY` |

### 8.2 MCP 服务器集成

支持通过以下方式集成 MCP 服务器：
- **stdio**: 标准输入输出通信
- **sse**: Server-Sent Events
- **http**: HTTP 流式通信

---

## 9. 安全性技术

### 9.1 密钥管理

- 支持环境变量存储 API 密钥
- 支持通过外部命令获取密钥（`api-key-cmd`）
- 配置文件中不强制存储密钥

### 9.2 网络安全

- 支持 HTTP 代理配置
- 支持 TLS/HTTPS 加密通信
- 使用官方 SDK 处理 API 调用

---

## 10. 性能优化技术

### 10.1 并发处理

- 使用 `golang.org/x/sync/errgroup` 进行并发操作
- 使用互斥锁保护共享资源
- 流式处理减少内存占用

### 10.2 缓存策略

- 本地文件缓存对话内容
- SQLite 数据库索引优化
- GOB 格式高效序列化

### 10.3 渲染优化

- 增量渲染 Markdown 内容
- 视口滚动优化
- 终端颜色检测和适配

---

## 11. 开发环境配置

### 11.1 必需工具

```bash
# Go 语言环境
go version  # 需要 1.24.2+

# 代码检查工具
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# 构建发布工具
go install github.com/goreleaser/goreleaser/v2@latest
```

### 11.2 推荐工具

```bash
# 代码格式化
go install mvdan.cc/gofumpt@latest

# 依赖管理
go mod tidy
```

---

## 12. 技术债务与改进计划

### 12.1 当前技术债务

1. 部分错误处理需要更细粒度的错误类型
2. 测试覆盖率有待提高
3. 文档注释需要完善

### 12.2 改进计划

1. 增加集成测试和端到端测试
2. 优化流式响应的错误恢复机制
3. 改进配置验证和错误提示

---

## 附录

### A. 完整依赖列表

详细的依赖列表请参考项目根目录下的 `go.mod` 文件。

### B. 相关文档

- [项目架构概述](./01-项目架构概述.md)
- [模块划分](./03-模块划分.md)
- [构建部署流程](../deployment/01-构建部署流程.md)

### C. 外部资源

- [Go 官方文档](https://golang.org/doc/)
- [Bubble Tea 文档](https://github.com/charmbracelet/bubbletea)
- [Cobra 文档](https://github.com/spf13/cobra)
- [OpenAI API 文档](https://platform.openai.com/docs)
